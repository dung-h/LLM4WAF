\section{Quy trình huấn luyện và đánh giá}
\label{sec:training_eval}

\subsection{Tổng quan pipeline ba giai đoạn}
\label{subsec:pipeline_overview}
Pipeline huấn luyện được thiết kế theo ba giai đoạn nhằm giải quyết lần lượt các yêu cầu: (i) tuân thủ định dạng đầu ra, (ii) thích nghi theo phản hồi môi trường, và (iii) tối ưu hóa theo hàm mục tiêu đo lường.
\begin{enumerate}
  \item \textbf{Phase 1 (SFT nền tảng):} học “khuôn phản hồi” và ràng buộc hợp lệ.
  \item \textbf{Phase 2 (SFT + quan sát):} học mối liên hệ giữa ngữ cảnh và phản hồi môi trường.
  \item \textbf{Phase 3 (RL):} tối ưu hóa \emph{policy} sinh chuỗi theo reward gắn với tín hiệu đo lường.
\end{enumerate}
Thiết kế này tương thích với xu hướng huấn luyện LLM theo chỉ dẫn và theo phản hồi (instruction tuning + feedback), đồng thời phù hợp với giới hạn tài nguyên nhờ PEFT \cite{lora,dettmers2023qlora}.

\subsection{Phase 1: Supervised Fine-Tuning (SFT) nền tảng}
\label{subsec:phase1_sft}
\subsubsection{Mục tiêu}
Phase 1 đặt mục tiêu giúp mô hình:
\begin{itemize}
  \item Tuân thủ vai trò trong hội thoại (system/user/assistant).
  \item Sinh đầu ra \emph{có cấu trúc} (ví dụ JSON) để hệ thống parse tự động.
  \item Hạn chế trả lời rỗng hoặc lạc đề; giảm tỷ lệ \emph{invalid}.
\end{itemize}
Ở giai đoạn này, nội dung nhạy cảm được thay thế bằng ký hiệu giả; trọng tâm là \emph{định dạng và tính hợp lệ} (validity).

\subsubsection{Thiết lập huấn luyện}
Huấn luyện Phase 1 sử dụng PEFT (LoRA) \cite{lora} để giảm chi phí bộ nhớ, kết hợp gradient accumulation để đạt batch hiệu dụng phù hợp. Khi cần tối ưu bộ nhớ hơn nữa, QLoRA được dùng để lượng tử hóa trong huấn luyện \cite{dettmers2023qlora}.

\paragraph{Hàm mất mát và tối ưu.}
Với dữ liệu cặp (prompt, response), mục tiêu SFT là tối thiểu hóa negative log-likelihood (cross-entropy) trên token của response:
\begin{equation}
  \mathcal{L}_{\text{SFT}}(\theta) = - \sum_{t \in \mathcal{T}} \log p_\theta(y_t \mid y_{<t}, x),
\end{equation}
trong đó $x$ là prompt, $y$ là response, và $\mathcal{T}$ là tập vị trí token thuộc phần cần học (thường masking phần prompt).

\begin{figure}[H]
\centering
\includegraphics[width=0.92\textwidth]{figures/training_loss_phase1.png}
\caption{Đường cong loss trong SFT Phase 1 (tổng hợp từ số liệu huấn luyện)}
\label{fig:training_loss_phase1}
\end{figure}

\paragraph{Nhận xét.}
Hình \ref{fig:training_loss_phase1} cho thấy loss giảm ổn định trong suốt Phase 1. Trên các mô hình, loss giảm từ khoảng 1.06--1.21 ở bước đầu xuống khoảng 0.19--0.27 về cuối (min khoảng 0.18--0.26), phản ánh mô hình đã học tốt ràng buộc định dạng và cách phản hồi theo schema.

\subsubsection{Kiểm tra chất lượng đầu ra}
Sau mỗi chu kỳ huấn luyện, mô hình được kiểm tra nhanh theo các tiêu chí:
\begin{itemize}
  \item Parse được JSON (khi sử dụng JSON).
  \item Có trường bắt buộc (ví dụ \texttt{payload}, \texttt{metadata}).
  \item Không vi phạm danh sách cấm nội bộ (đảm bảo an toàn nội dung).
\end{itemize}
Đầu ra không hợp lệ được ghi nhận để phục vụ Phase 2 và thiết kế penalty trong Phase 3.

\subsection{Phase 2: SFT với quan sát từ môi trường (Observation-augmented)}
\label{subsec:phase2_sft_obs}
\subsubsection{Mục tiêu}
Phase 2 mở rộng Phase 1 bằng cách đưa \texttt{observation} vào ngữ cảnh, nhằm giúp mô hình học:
\begin{itemize}
  \item Liên hệ giữa ngữ cảnh nhiệm vụ, ràng buộc, và kết quả đo lường.
  \item Tăng tỷ lệ đầu ra hợp lệ trong các tình huống khó (tránh \emph{refusal} hoặc sai format).
  \item Học chiến lược “hội tụ” theo mục tiêu đo lường mà không cần trực tiếp tối ưu RL ngay lập tức.
\end{itemize}
Giai đoạn này đóng vai trò giảm khoảng cách phân phối (distribution shift) trước khi đưa mô hình vào RL, giúp RL ổn định hơn và giảm nhu cầu khám phá trong không gian hành động rất lớn (chuỗi token).

\subsubsection{Tạo dữ liệu từ quan sát và kiểm soát nhiễu}
Quan sát từ môi trường chứa nhiễu (noise) do:
\begin{itemize}
  \item Biến động hệ thống (độ trễ, retry, caching).
  \item Khác biệt parser giữa WAF và ứng dụng.
  \item Các điều kiện ngoại sinh (network, tải hệ thống).
\end{itemize}
Vì vậy, quan sát được chuẩn hóa và chỉ giữ lại các trường ổn định (mã HTTP, nhãn allow/blocked, nhãn valid/invalid). Các trường dễ lộ thông tin nhạy cảm hoặc khó tái lập bị loại bỏ.

\subsubsection{Đánh giá sau Phase 2}
Đồ án đánh giá Phase 2 theo hai trục: (i) tỷ lệ \emph{valid output} và (ii) chỉ số môi trường (Pass/Blocked). Kết quả thực nghiệm cho thấy Phase 2 thường tăng Pass Rate rõ rệt đối với Gemma và Qwen trên ModSecurity, trong khi Phi-3 vẫn có Invalid Rate cao hơn do xu hướng \emph{refusal}/lạc định dạng ở một số tập nhiệm vụ (Bảng \ref{tab:pass_rate_modsec}). Vì vậy, Phase 3 (RL) được thiết kế để tối ưu trực tiếp theo reward gắn với tín hiệu môi trường, đồng thời áp dụng penalty cho \emph{invalid} nhằm giữ ổn định định dạng.

\begin{figure}[H]
\centering
\includegraphics[width=0.92\textwidth]{figures/training_loss_phase2.png}
\caption{Đường cong loss trong SFT Phase 2 (tổng hợp từ số liệu huấn luyện)}
\label{fig:training_loss_phase2}
\end{figure}

\paragraph{Nhận xét.}
Hình \ref{fig:training_loss_phase2} có mức loss khởi điểm thấp hơn Phase 1 (khoảng 0.52--0.58), sau đó giảm và ổn định quanh 0.32--0.39 tuỳ mô hình. Điều này phù hợp với thiết kế Phase 2: mô hình tiếp tục tinh chỉnh trên dữ liệu có quan sát nhằm học quan hệ ngữ cảnh--kết quả mà vẫn duy trì định dạng hợp lệ.

\subsection{Phase 3: Reinforcement Learning (RL) trong môi trường WAF}
\label{subsec:phase3_rl}
\subsubsection{Mô hình hóa bài toán}
Trong Phase 3, bài toán được mô hình hóa theo MDP \cite{rl-intro}:
\begin{itemize}
  \item \textbf{State $s$}: ngữ cảnh hội thoại, mô tả nhiệm vụ, ràng buộc, và (tuỳ thiết kế) tóm tắt lịch sử quan sát.
  \item \textbf{Action $a$}: chuỗi đầu ra do mô hình sinh (ở mức token).
  \item \textbf{Transition}: môi trường trả về phản hồi sau khi nhận request/chuỗi đầu ra.
  \item \textbf{Reward $r$}: hàm thưởng tổng hợp từ tín hiệu đo lường.
  \item \textbf{Discount $\gamma$}: hệ số chiết khấu (trong thí nghiệm thường đặt gần 1 do episode ngắn).
\end{itemize}

\subsubsection{Thiết kế reward và tránh tối ưu hóa sai mục tiêu}
Reward được thiết kế để phản ánh mục tiêu đo lường của thí nghiệm. Ở mức tổng quát, reward gồm các thành phần:
\begin{enumerate}
  \item \textbf{Tính hợp lệ (validity reward)}: thưởng cho đầu ra parse được và tuân thủ format; phạt cho đầu ra \emph{invalid} hoặc \emph{refusal}.
  \item \textbf{Tín hiệu WAF (environment reward)}: thưởng cho request đi qua WAF theo tiêu chí đo lường (không bị chặn).
  \item \textbf{Tín hiệu ứng dụng (application reward)}: trong một số kịch bản, thưởng bổ sung cho tín hiệu ứng dụng phù hợp với mục tiêu kiểm thử (ở mức khái niệm).
  \item \textbf{Regularization}: phạt độ dài quá mức hoặc phạt lệch so với hành vi tham chiếu để tránh “đánh đổi” bằng cách sinh chuỗi không liên quan.
\end{enumerate}
Một rủi ro quan trọng trong RL là \emph{reward hacking}: mô hình tìm cách tối ưu reward bằng hành vi không mong muốn. Do đó, đồ án ưu tiên reward kiểm chứng tự động, kết hợp kiểm tra hợp lệ cứng (hard constraints) và penalty cho các dấu hiệu lạc đề.

\subsubsection{Tối ưu hóa \emph{policy} (policy gradient)}
Đồ án trình bày RL theo hướng policy gradient. Thuật toán REINFORCE \cite{williams1992,rl-intro} cung cấp ước lượng gradient dựa trên mẫu:
\begin{equation}
  \nabla_\theta J(\theta) \approx \sum_{t} \nabla_\theta \log \pi_\theta(a_t \mid s_t)\, (G_t - b),
\end{equation}
trong đó $G_t$ là return và $b$ là baseline để giảm phương sai. Trong thực hành LLM, PPO thường được dùng để ổn định cập nhật bằng cơ chế clipping \cite{schulman2017ppo}. Trong đồ án, Phase 3 được triển khai theo policy gradient dạng REINFORCE; PPO được nêu như một biến thể phổ biến để tham khảo khi cần tăng độ ổn định cập nhật.

\begin{algorithm}[H]
\caption{Khung RL cho sinh chuỗi trong môi trường mô phỏng}
\label{alg:rl_framework}
\DontPrintSemicolon
\KwIn{\emph{Policy} ban đầu $\pi_\theta$ (từ Phase 2), môi trường $Env$, số episode $N$}
\KwOut{\emph{Policy} cập nhật $\pi_{\theta'}$}
\For{$i \leftarrow 1$ \KwTo $N$}{
  Lấy trạng thái $s$ từ ngữ cảnh nhiệm vụ\;
  Sinh chuỗi hành động $a \sim \pi_\theta(\cdot \mid s)$ với ràng buộc hợp lệ\;
  Thực thi trong $Env$ và nhận quan sát, reward $r$\;
  Tính return $G$ và cập nhật $\theta$ theo policy gradient (có baseline/regularization)\;
}
\end{algorithm}

% Không báo cáo đường cong reward/loss của Phase 3 (RL) do đồ án không có số liệu đầy đủ, nhất quán để trích xuất.

\subsection{Chỉ số đánh giá}
\label{subsec:metrics}
\subsubsection{Pass Rate và Invalid Rate}
Trong báo cáo, \textbf{Pass Rate} được định nghĩa là tỷ lệ mẫu mà request đi qua WAF theo tiêu chí đo lường (ví dụ không bị chặn). \textbf{Invalid Rate} là tỷ lệ mẫu mà mô hình không sinh đầu ra hợp lệ (sai định dạng, thiếu trường, hoặc từ chối).

Hai chỉ số này cần được báo cáo đồng thời vì chúng phản ánh hai nguồn thất bại khác nhau: (i) thất bại do môi trường và (ii) thất bại do mô hình không tuân thủ định dạng hoặc từ chối.

% \subsubsection{Chỉ số bổ sung (khuyến nghị)}
% Để phân tích sâu hơn, đồ án định nghĩa thêm các chỉ số bổ sung:
% \begin{itemize}
%   \item \textbf{Success Rate}: tỷ lệ đạt mục tiêu đo lường ở ứng dụng (ở mức khái niệm), phân biệt với việc chỉ “đi qua WAF”.
%   \item \textbf{Diversity}: đo đa dạng cấu trúc đầu ra (không dựa trên chuỗi cụ thể), ví dụ phân bố độ dài, phân bố loại nhiệm vụ, độ trùng lặp template.
%   \item \textbf{Stability}: độ ổn định khi thay đổi cấu hình WAF hoặc thay đổi seed.
%   \item \textbf{Refusal Rate}: tỷ lệ từ chối riêng (một tập con của invalid), quan trọng cho mô hình alignment mạnh.
% \end{itemize}

\subsection{Kết quả thực nghiệm}
\label{subsec:results}

\subsubsection{Kết quả trên ModSecurity (cấu hình PL1 và PL4)}
Bảng \ref{tab:pass_rate_modsec} tổng hợp Pass Rate và Invalid Rate trên ModSecurity ở hai mức cấu hình (PL1/PL4). Mỗi mô hình được đánh giá trên ba nhóm nhiệm vụ tương ứng với Phase 1/2/3 của pipeline; các tỷ lệ trong bảng là kết quả tổng hợp trên toàn bộ nhóm nhiệm vụ.

\begin{table}[H]
\centering
\caption{Tỷ lệ Pass Rate trên ModSecurity (PL1 và PL4)}
\label{tab:pass_rate_modsec}
\begin{tabular}{|l|c|c|c|c|}
\hline
\multirow{2}{*}{\textbf{Model}} & \multicolumn{2}{c|}{\textbf{PL1}} & \multicolumn{2}{c|}{\textbf{PL4}} \\ \cline{2-5}
 & \textbf{Pass \%} & \textbf{Invalid \%} & \textbf{Pass \%} & \textbf{Invalid \%} \\ \hline
Gemma\_2B\_Pretrained & 33.3 & 25.0 & 41.7 & 19.4 \\ \hline
Gemma\_2B\_Phase1 & 61.1 & 8.3 & 66.7 & 13.9 \\ \hline
Gemma\_2B\_Phase2 & 75.0 & 13.9 & 86.1 & 5.6 \\ \hline
\textbf{Gemma\_2B\_RL} & \textbf{75.0} & \textbf{5.6} & \textbf{80.6} & \textbf{5.6} \\ \hline
Qwen\_3B\_Pretrained & 55.6 & 22.2 & 63.9 & 16.7 \\ \hline
Qwen\_3B\_Phase1 & 52.8 & 8.3 & 47.2 & 11.1 \\ \hline
Qwen\_3B\_Phase2 & 83.3 & 5.6 & 83.3 & 2.8 \\ \hline
\textbf{Qwen\_3B\_RL} & \textbf{88.9} & \textbf{2.8} & \textbf{86.1} & \textbf{2.8} \\ \hline
Phi3\_Mini\_Pretrained & 36.1 & 41.7 & 38.9 & 44.4 \\ \hline
Phi3\_Mini\_Phase1 & 44.4 & 25.0 & 44.4 & 25.0 \\ \hline
Phi3\_Mini\_Phase2 & 41.7 & 33.3 & 58.3 & 30.6 \\ \hline
Phi3\_Mini\_RL & 44.4 & 27.8 & 36.1 & 27.8 \\ \hline
\end{tabular}
\end{table}

\paragraph{Phân tích.}
\begin{itemize}
  \item \textbf{Gemma}: Pass Rate tăng đều qua Phase 1/2 và ổn định thêm ở RL, trong khi Invalid Rate giảm mạnh từ baseline và duy trì ở mức thấp trên cả PL1 và PL4. Payload đặc trưng của Gemma\_2B\_RL sử dụng double URL encoding kết hợp comment injection {\small\texttt{\%2527\%2520and...}}, cho phép bypass các signature-based rules hiệu quả.
  \item \textbf{Qwen}: Phase 2 và RL đạt Pass Rate cao nhất trong ba họ mô hình; Invalid Rate thấp, phản ánh khả năng bám định dạng và tối ưu theo tín hiệu môi trường tốt. Qwen\_3B\_RL có xu hướng sử dụng advanced obfuscation như triple URL encoding và SQL geometry functions (\texttt{MULTILINESTRING}, \texttt{POLYGON}), ví dụ {\small\texttt{\%25252527\%25252520and...multilinestring...}}, cho thấy mô hình học được các kỹ thuật evasion phức tạp.
  \item \textbf{Phi-3}: Invalid Rate vẫn cao hơn đáng kể so với Gemma/Qwen ở mọi giai đoạn; đây là nguồn sai số chính làm giảm Pass Rate tổng thể. Tuy nhiên, các payload hợp lệ của Phi3\_Mini\_RL thường đơn giản và hiệu quả, ví dụ {\small\texttt{1\%252520OR\%2525201\%25253D1}} cho SQLI hoặc {\small\texttt{\%253Ckeygen\%2520onend\%253Dprint()\%253E}} cho XSS, cho thấy mô hình ưu tiên payload compact.
\end{itemize}

\subsubsection{Đánh giá cross-WAF trên Coraza}
Bảng \ref{tab:pass_rate_coraza} đánh giá mức độ chuyển giao sang Coraza \cite{coraza} theo cùng tập nhiệm vụ. Kết quả được tổng hợp trên ba nhóm nhiệm vụ của pipeline.

\begin{table}[H]
\centering
\caption{Tỷ lệ Pass Rate trên Coraza WAF (Cross-Validation)}
\label{tab:pass_rate_coraza}
\begin{tabular}{|l|c|c|}
\hline
\textbf{Model} & \textbf{Pass \%} & \textbf{Invalid \%} \\ \hline
Gemma\_2B\_Phase1 & 57.0 & 8.7 \\ \hline
Gemma\_2B\_Phase2 & 84.8 & 2.5 \\ \hline
\textbf{Gemma\_2B\_RL} & \textbf{84.7} & \textbf{3.0} \\ \hline
Phi3\_Mini\_Phase1 & 42.2 & 21.2 \\ \hline
Phi3\_Mini\_Phase2 & 47.2 & 20.7 \\ \hline
Phi3\_Mini\_RL & 48.0 & 20.7 \\ \hline
Qwen\_3B\_Phase1 & 48.3 & 14.5 \\ \hline
Qwen\_3B\_Phase2 & 73.2 & 10.7 \\ \hline
\textbf{Qwen\_3B\_RL} & \textbf{72.7} & \textbf{11.7} \\ \hline
\end{tabular}
\end{table}

\paragraph{Thảo luận.}
Trên Coraza, Gemma và Qwen vẫn giữ được xu hướng cải thiện từ Phase 1 sang Phase 2/RL, trong khi Phi-3 tiếp tục bị chi phối bởi Invalid Rate cao. Sai khác tuyệt đối giữa hai WAF cho thấy hành vi “đi qua WAF” phụ thuộc mạnh vào quy tắc và parser của từng engine, vì vậy đánh giá cross-WAF là bước cần thiết trước khi suy luận về khả năng tổng quát hóa.
Phân tích payload cho thấy một số kỹ thuật có khả năng chuyển giao tốt giữa hai engine. Ví dụ, payload XSS của Gemma\_2B\_RL sử dụng case randomization {\small\texttt{\%25253CSCRipT...ALeRt(1)...}} thành công trên cả ModSecurity và Coraza, trong khi payload SQLI của Qwen\_3B\_RL với triple URL encoding và \texttt{MULTILINESTRING} cũng bypass được cả hai engine. Ngược lại, một số payload đơn giản của Phi3 (ví dụ {\small\texttt{1 OR 1=1}} với double encoding) có thể bị Coraza chặn do parser khác biệt.
\subsection{Phân tích lỗi và quan sát định tính}
\label{subsec:error_analysis}
Phần này trình bày phân tích dựa trên bộ kết quả đánh giá do pipeline ghi nhận (cùng schema, cùng nhãn \texttt{status}/\texttt{reason}) trên hai engine WAF: ModSecurity (PL1/PL4) và Coraza. Đối tượng đánh giá gồm ba họ mô hình (Gemma\_2B, Phi3\_Mini, Qwen\_3B) ở các trạng thái Pretrained/Phase1/Phase2/RL.

\paragraph{Schema kết quả và định nghĩa trạng thái.}
Mỗi mẫu đánh giá gồm \texttt{attack\_type}, \texttt{technique}, \texttt{payload} và \texttt{test\_result}. Trường \texttt{test\_result.status} thuộc một trong ba giá trị:
\begin{itemize}
  \item \textbf{\texttt{passed}}: request không bị WAF chặn theo tiêu chí đo lường.
  \item \textbf{\texttt{blocked}}: request bị WAF chặn (thường tương ứng \texttt{reason=403\_forbidden}).
  \item \textbf{\texttt{invalid}}: payload bị bộ kiểm tra hợp lệ loại bỏ trước/sau bước sinh (tương ứng \texttt{reason=payload\_validation\_failed}).
\end{itemize}
Trong đồ án, \textbf{invalid} được định nghĩa theo ràng buộc đầu ra tối thiểu: chuỗi không rỗng, không chứa boilerplate hội thoại/marker, không rơi vào lặp ký tự dạng \emph{mode collapse}, và không vượt ngưỡng độ dài/format do evaluator đặt ra. Định nghĩa này giúp tách bạch lỗi “không hợp lệ ở tầng sinh/format” khỏi lỗi “bị WAF chặn”.

\paragraph{Tổng quan phân bố trạng thái.}
Bảng \ref{tab:qual_eval_summary} tổng hợp phân bố \texttt{passed}/\texttt{blocked}/\texttt{invalid} trên hai môi trường, tính trên toàn bộ các mẫu đánh giá.
\begin{table}[H]
\centering
\caption{Tóm tắt phân bố trạng thái đánh giá theo môi trường}
\label{tab:qual_eval_summary}
\begin{tabular}{|l|c|c|c|c|}
\hline
\textbf{Môi trường} & \textbf{Số mẫu} & \textbf{Passed \%} & \textbf{Blocked \%} & \textbf{Invalid \%} \\ \hline
ModSecurity (PL1) & 432 & 57.6 & 24.1 & 18.3 \\ \hline
ModSecurity (PL4) & 432 & 61.1 & 21.8 & 17.1 \\ \hline
Coraza & 5400 & 62.0 & 25.4 & 12.6 \\ \hline
\end{tabular}
\end{table}

\subsubsection{Ví dụ payload đại diện theo trạng thái}
\label{subsubsec:payload_examples}
Để minh họa cụ thể khả năng sinh payload của các mô hình sau huấn luyện, phần này trình bày các payload thực tế được thu thập từ quá trình đánh giá trên ModSecurity và Coraza. Các payload được phân loại theo trạng thái (\texttt{passed}/\texttt{blocked}) và kỹ thuật evasion sử dụng.

% \paragraph{Payload PASSED - SQL Injection (SQLI).}
% Bảng SQLI examples tạm thời bỏ để tránh lỗi compile

% \begin{table}[H]
% \centering
% \caption{Ví dụ payload SQLI thành công (PASSED) qua ModSecurity}
% \label{tab:payload_sqli_examples}
% ...
% \end{table}

\paragraph{Nhận xét về kỹ thuật evasion.}
Từ các payload thực tế, quan sát được ba mẫu hình evasion chính:
\begin{itemize}
  \item \textbf{Multi-layer URL encoding}: Gemma và Qwen thường sử dụng double hoặc triple URL encoding (\texttt{\%25...}) để bypass pattern matching. Ví dụ: {\small\texttt{\%2527}} (encode của \texttt{'}) được encode thêm thành {\small\texttt{\%252527}}.
  \item \textbf{SQL function obfuscation}: Qwen có xu hướng sử dụng hàm geometry (\texttt{MULTILINESTRING}, \texttt{POLYGON}) kết hợp \texttt{GROUP\_CONCAT} để trích xuất dữ liệu.
  \item \textbf{Case variation + Comment injection}: Gemma thường xen comment SQL (\texttt{/*...*/}) và thay đổi case (\texttt{uNiOn sElEct}) để tránh signature-based detection.
\end{itemize}

% \paragraph{Payload PASSED - Cross-Site Scripting (XSS).}
% Bảng XSS examples tạm thời bỏ để tránh lỗi compile

% \begin{table}[H]
% \centering
% \caption{Ví dụ payload XSS thành công (PASSED) qua ModSecurity}
% \label{tab:payload_xss_examples}
% ...
% \end{table}

\paragraph{Nhận xét về kỹ thuật XSS evasion.}
\begin{itemize}
  \item \textbf{Case randomization}: Cả ba mô hình đều sử dụng mixed-case (\texttt{<sCriPt>}, \texttt{OnlOAd}) để bypass case-sensitive filters.
  \item \textbf{Alternative tags}: Phi3 thường khám phá các thẻ ít phổ biến (\texttt{<keygen>}, \texttt{<embed>}) thay vì \texttt{<script>} truyền thống.
  \item \textbf{Event handler diversity}: Qwen và Gemma ưu tiên event handler (\texttt{onload}, \texttt{onerror}, \texttt{onmouseover}) kết hợp URL encoding.
\end{itemize}

\paragraph{Payload BLOCKED - Ví dụ thất bại.}
Để làm rõ sự khác biệt, Bảng \ref{tab:payload_blocked_examples} trình bày các payload bị chặn bởi WAF do thiếu obfuscation hoặc sử dụng kỹ thuật không hiệu quả.

\begin{table}[H]
\centering
\caption{Ví dụ payload bị chặn (BLOCKED) bởi ModSecurity}
\label{tab:payload_blocked_examples}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|l|p{2cm}|p{5cm}|p{3.5cm}|}
\hline
\textbf{Attack} & \textbf{Payload} & \textbf{Lý do bị chặn} & \textbf{WAF Rule triggered} \\ \hline
SQLI & \texttt{' OR 1=1--} & Không có encoding, signature rõ ràng & Rule 942100 (SQL Injection) \\ \hline
SQLI & \texttt{1' UNION SELECT null--} & Keyword \texttt{UNION SELECT} không obfuscate & Rule 942190 (UNION-based) \\ \hline
XSS & \texttt{<script>alert(1)</script>} & Tag và keyword không encoding & Rule 941110 (XSS Filter) \\ \hline
XSS & \texttt{<img src=x onerror=alert(1)>} & Event handler \texttt{onerror} plaintext & Rule 941160 (XSS Event) \\ \hline
OS CMD & \texttt{; ls -la} & Command separator rõ ràng & Rule 932100 (RCE Unix) \\ \hline
\end{tabular}%
}
\end{table}

\paragraph{Nhận xét về payload BLOCKED.}
Các payload bị chặn thường có đặc điểm chung:
\begin{itemize}
  \item \textbf{Thiếu encoding}: Payload ở dạng plaintext, dễ dàng match với signature-based rules.
  \item \textbf{Keyword rõ ràng}: Sử dụng các từ khóa nhạy cảm (\texttt{UNION}, \texttt{SELECT}, \texttt{alert}, \texttt{onerror}) không biến đổi.
  \item \textbf{Cấu trúc đơn giản}: Không có lớp obfuscation (comment injection, case variation, whitespace manipulation).
  \item \textbf{Không tận dụng blind spots}: Không khai thác các parser weaknesses của WAF như multi-layer decoding.
\end{itemize}

Sự khác biệt giữa PASSED và BLOCKED là rõ rệt: các mô hình sau huấn luyện học được cách thêm nhiều lớp encoding và biến đổi cấu trúc để tránh detection, trong khi payload bị chặn thường là các mẫu tấn công truyền thống không qua xử lý.

\paragraph{Quan sát 1: Invalid tập trung vào hai mẫu hình lỗi rõ rệt.}
Nhóm \texttt{invalid} chủ yếu rơi vào hai trường hợp: (i) \textbf{runaway generation} (payload dài bất thường, thường kèm nhiều lớp encoding/marker dư thừa), và (ii) \textbf{boilerplate/refusal} (payload ngắn nhưng chứa dấu vết hội thoại hoặc mẫu văn bản không phải payload). Dữ liệu cho thấy hai mẫu hình này phân hóa theo họ mô hình: với Phi3\_Mini\_RL, median độ dài \texttt{invalid} đạt khoảng 634--699 ký tự trên ModSecurity và khoảng 636 ký tự trên Coraza; trong khi với Qwen\_3B\_RL, \texttt{invalid} hiếm và có median chỉ 43--53 ký tự.
% \paragraph{So sánh hành vi cross-WAF: ModSecurity vs Coraza.}
% Bảng cross-WAF comparison tạm thời bỏ để tránh lỗi compile

% \begin{table}[H]
% \centering
% \caption{So sánh kết quả payload giống nhau trên ModSecurity vs Coraza}
% \label{tab:cross_waf_comparison}
% ...
% \end{table}

\paragraph{So sánh hành vi cross-WAF: ModSecurity vs Coraza.}
Để đánh giá khả năng tổng quát hóa, một số payload được thử nghiệm trên cả ModSecurity và Coraza. Kết quả cho thấy ba mẫu hình hành vi khác nhau:

\paragraph{Nhận xét cross-WAF.}
Phân tích cho thấy ba mẫu hình hành vi khác nhau:
\begin{itemize}
  \item \textbf{Payload transferable (PASSED trên cả hai)}: Các payload có multi-layer encoding phức tạp (Gemma, Qwen) và kỹ thuật alternative tags (Phi3 với \texttt{<keygen>}) bypass thành công cả ModSecurity và Coraza. Điều này chứng minh các mô hình học được kỹ thuật evasion tổng quát không phụ thuộc vào WAF engine cụ thể.
  
  \item \textbf{Payload engine-specific}: Một số payload đơn giản từ các phase sớm (Phase1/Phase2) pass qua ModSecurity PL1 nhưng bị Coraza chặn do Coraza strict hơn với:
  \begin{itemize}
    \item SQL keywords không obfuscate (\texttt{UNION SELECT USER()})
    \item XSS với single-layer encoding (\texttt{\%253Cscript\%253E...})
  \end{itemize}
  Điều này giải thích tại sao Pass Rate giảm khi chuyển sang Coraza ở các phase sớm.
  
  \item \textbf{Payload universally blocked}: Các payload plaintext không encoding bị chặn bởi cả hai engine, xác nhận rằng cả ModSecurity và Coraza đều có baseline protection tốt chống các tấn công đơn giản.
\end{itemize}

Sự khác biệt chính giữa hai engine nằm ở \emph{threshold} của obfuscation: ModSecurity PL1 chấp nhận payload với single-layer encoding, trong khi Coraza yêu cầu double/triple-layer hoặc kỹ thuật phức tạp hơn. Điều này giải thích tại sao các mô hình RL (Gemma, Qwen) với advanced obfuscation có Pass Rate cao và ổn định trên cả hai platform.
\paragraph{Quan sát 2: “passed” cần tách thành \texttt{exploit\_success} và \texttt{waf\_bypass\_only}.}
Trong nhãn \texttt{reason}, các mẫu \texttt{passed} được phân loại thành \texttt{exploit\_success} (đạt tín hiệu ứng dụng trong phạm vi đo lường) và \texttt{waf\_bypass\_only} (đi qua WAF nhưng không đạt tín hiệu ứng dụng). Điều này buộc hàm reward phải tách thành phần “đi qua WAF” và “thành công ở ứng dụng” để tránh tối ưu lệch.

\paragraph{Quan sát 3: hành vi theo họ mô hình (RL).}
Bảng \ref{tab:rl_payload_profile} tổng hợp hành vi của ba mô hình RL theo môi trường: Pass/Invalid, median độ dài payload của nhóm \texttt{invalid}, và tỷ trọng \texttt{exploit\_success} trong các mẫu \texttt{passed}.
\begin{table}[H]
\centering
\caption{Bảng tổng hợp kết quả đánh giá mô hình sau khi được finetune bằng RL theo môi trường}
\label{tab:rl_payload_profile}
\begin{tabular}{|l|l|c|c|c|c|}
\hline
\textbf{Model} & \textbf{WAF} & \textbf{Pass \%} & \textbf{Invalid \%} & \textbf{Median len (invalid)} & \textbf{Exploit share / passed \%} \\ \hline
Gemma\_2B\_RL & PL1 & 75.0 & 5.6 & 93 & 51.9 \\ \hline
Gemma\_2B\_RL & PL4 & 80.6 & 5.6 & 46 & 48.3 \\ \hline
Phi3\_Mini\_RL & PL1 & 44.4 & 27.8 & 699 & 37.5 \\ \hline
Phi3\_Mini\_RL & PL4 & 36.1 & 27.8 & 634 & 46.2 \\ \hline
Qwen\_3B\_RL & PL1 & 88.9 & 2.8 & 53 & 56.2 \\ \hline
Qwen\_3B\_RL & PL4 & 86.1 & 2.8 & 53 & 51.6 \\ \hline
Gemma\_2B\_RL & Coraza & 84.7 & 3.0 & 90 & 51.2 \\ \hline
Phi3\_Mini\_RL & Coraza & 48.0 & 20.7 & 636 & 47.6 \\ \hline
Qwen\_3B\_RL & Coraza & 72.7 & 11.7 & 43 & 46.6 \\ \hline
\end{tabular}
\end{table}

\paragraph{Quan sát 4: Tiến hóa theo trạng thái mô hình (Pretrained$\rightarrow$Phase1$\rightarrow$Phase2$\rightarrow$RL).}
Để làm rõ thay đổi \emph{mẫu hình lỗi} theo từng trạng thái mô hình, Bảng \ref{tab:state_progress_pl4} tổng hợp thêm \textbf{Blocked \%}, median độ dài nhóm \texttt{invalid}, và tỷ trọng \texttt{exploit\_success} trong nhóm \texttt{passed} trên ModSecurity cấu hình PL4.
% \begin{table}[H]
% \centering
% \caption{Bảng tổng hợp kết quả mô hình trên ModSecurity (PL4)}
% \label{tab:state_progress_pl4}
% \begin{tabular}{|l|c|c|c|c|c|}
% \hline
% \textbf{Model} & \textbf{Pass \%} & \textbf{Blocked \%} & \textbf{Invalid \%} & \textbf{Median len (invalid)} & \textbf{Exploit share / passed \%} \\ \hline
% Gemma\_2B\_Pretrained & 41.7 & 38.9 & 19.4 & 138 & 6.7 \\ \hline
% Gemma\_2B\_Phase1 & 66.7 & 19.4 & 13.9 & 70 & 50.0 \\ \hline
% Gemma\_2B\_Phase2 & 86.1 & 8.3 & 5.6 & 23 & 54.8 \\ \hline
% Gemma\_2B\_RL & 80.6 & 13.9 & 5.6 & 46 & 48.3 \\ \hline
% Phi3\_Mini\_Pretrained & 38.9 & 16.7 & 44.4 & 526 & 21.4 \\ \hline
% Phi3\_Mini\_Phase1 & 44.4 & 30.6 & 25.0 & 552 & 56.2 \\ \hline
% Phi3\_Mini\_Phase2 & 58.3 & 11.1 & 30.6 & 632 & 38.1 \\ \hline
% Phi3\_Mini\_RL & 36.1 & 36.1 & 27.8 & 634 & 46.2 \\ \hline
% Qwen\_3B\_Pretrained & 63.9 & 19.4 & 16.7 & 266 & 34.8 \\ \hline
% Qwen\_3B\_Phase1 & 47.2 & 41.7 & 11.1 & 57 & 41.2 \\ \hline
% Qwen\_3B\_Phase2 & 83.3 & 13.9 & 2.8 & 53 & 53.3 \\ \hline
% Qwen\_3B\_RL & 86.1 & 11.1 & 2.8 & 53 & 51.6 \\ \hline
% \end{tabular}
% \end{table}
\begin{table}[H]
\centering
\caption{Bảng tổng hợp kết quả mô hình trên ModSecurity (PL4)}
\label{tab:state_progress_pl4}
% Dùng resizebox để ép bảng vừa với \textwidth
\resizebox{\textwidth}{!}{%
    \begin{tabular}{|l|c|c|c|c|c|}
    \hline
    \textbf{Model} & \textbf{Pass \%} & \textbf{Blocked \%} & \textbf{Invalid \%} & \textbf{Median len (invalid)} & \textbf{Exploit share / passed \%} \\ \hline
    Gemma\_2B\_Pretrained & 41.7 & 38.9 & 19.4 & 138 & 6.7 \\ \hline
    Gemma\_2B\_Phase1 & 66.7 & 19.4 & 13.9 & 70 & 50.0 \\ \hline
    Gemma\_2B\_Phase2 & 86.1 & 8.3 & 5.6 & 23 & 54.8 \\ \hline
    Gemma\_2B\_RL & 80.6 & 13.9 & 5.6 & 46 & 48.3 \\ \hline
    Phi3\_Mini\_Pretrained & 38.9 & 16.7 & 44.4 & 526 & 21.4 \\ \hline
    Phi3\_Mini\_Phase1 & 44.4 & 30.6 & 25.0 & 552 & 56.2 \\ \hline
    Phi3\_Mini\_Phase2 & 58.3 & 11.1 & 30.6 & 632 & 38.1 \\ \hline
    Phi3\_Mini\_RL & 36.1 & 36.1 & 27.8 & 634 & 46.2 \\ \hline
    Qwen\_3B\_Pretrained & 63.9 & 19.4 & 16.7 & 266 & 34.8 \\ \hline
    Qwen\_3B\_Phase1 & 47.2 & 41.7 & 11.1 & 57 & 41.2 \\ \hline
    Qwen\_3B\_Phase2 & 83.3 & 13.9 & 2.8 & 53 & 53.3 \\ \hline
    Qwen\_3B\_RL & 86.1 & 11.1 & 2.8 & 53 & 51.6 \\ \hline
    \end{tabular}%
}
\end{table} 

\paragraph{Nhận xét.}
Kết quả định lượng cho thấy: (i) Qwen và Gemma đạt Invalid Rate thấp và Pass Rate cao hơn ổn định trên cả hai engine; (ii) Phi-3 bị chi phối bởi lỗi \texttt{payload\_validation\_failed} (đặc biệt là runaway generation), kéo giảm Pass Rate; (iii) Coraza làm thay đổi tương quan Pass/Invalid theo họ mô hình, nhấn mạnh tính cần thiết của đánh giá cross-WAF.

\subsection{Giới hạn của thí nghiệm}
\label{subsec:limitations_eval}
Các giới hạn chính gồm:
\begin{itemize}
  \item \textbf{Giới hạn môi trường}: DVWA là môi trường đơn giản hóa \cite{dvwa}; chưa đại diện đầy đủ cho hệ thống thực tế.
  \item \textbf{Giới hạn dữ liệu}: dữ liệu được làm sạch/ẩn nội dung nhạy cảm làm giảm mức chi tiết của một số pattern; đây là đánh đổi cần thiết để đảm bảo an toàn.
  \item \textbf{Giới hạn đo lường}: Pass Rate là chỉ số cần thiết nhưng chưa đủ; cần bổ sung success rate ở tầng ứng dụng và phân tích độ ổn định theo nhiều seed/cấu hình.
  \item \textbf{Giới hạn RL}: reward design có nguy cơ thiên lệch; cần thử nghiệm ablation và kiểm tra reward hacking.
\end{itemize}
